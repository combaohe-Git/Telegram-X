name: TGX_Cloud_Production
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # --- 这里是“前几步”的核心：清理空间 ---
      - name: 1. 深度清理硬盘空间
        run: |
          echo "清理前空间状态："
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android/sdk/platforms/android-28
          sudo rm -rf /usr/local/lib/android/sdk/platforms/android-29
          sudo rm -rf /usr/local/share/boost
          sudo docker image prune -a -f
          echo "清理后空间状态："
          df -h

      - name: 2. 拉取代码
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: 3. 安装 NDK 23.2
        run: |
          # 先删掉默认自带的旧版 NDK 腾空间
          sudo rm -rf /usr/local/lib/android/sdk/ndk/*
          yes | sudo /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager --install "ndk;23.2.8568313"

      - name: 4. 设置 Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'

      - name: 5. 写入 API 密钥
        run: |
          echo "telegram.api_id=39843586" > local.properties
          echo "telegram.api_hash=6566d860f3317765664161c9e88b901a" >> local.properties
          echo "ndk.dir=/usr/local/lib/android/sdk/ndk/23.2.8568313" >> local.properties

      - name: 6. 开始编译 (单线程抗压模式)
        run: |
          chmod +x gradlew
          ./gradlew :app:assembleDebug --no-daemon -Dorg.gradle.workers.max=1 -x test -x lint

      - name: 7. 提取并上传 APK
        if: always()
        run: |
          mkdir -p output
          find . -name "*.apk" -exec cp {} ./output/ \;
        
      - name: 8. 发布成品
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: TGX_Final_Fixed_APK
          path: output/
