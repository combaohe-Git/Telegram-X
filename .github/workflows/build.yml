name: TGX_FINAL_OWNER_BUILD
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 清理空间
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android/sdk/platforms/android-28 /usr/local/lib/android/sdk/platforms/android-29
          sudo docker image prune -a -f

      - name: 2. 克隆代码 (含子模块)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: 3. 安装 NDK 23.2
        run: |
          sudo rm -rf /usr/local/lib/android/sdk/ndk/*
          yes | sudo /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager --install "ndk;23.2.8568313"

      - name: 4. 写入 API 密钥与路径
        run: |
          echo "ndk.dir=/usr/local/lib/android/sdk/ndk/23.2.8568313" > local.properties
          echo "telegram.api_id=39843586" >> local.properties
          echo "telegram.api_hash=6566d860f3317765664161c9e88b901a" >> local.properties

      - name: 5. 暴力编译
        continue-on-error: true
        run: |
          chmod +x gradlew
          export GRADLE_OPTS="-Xmx4g"
          ./gradlew :app:assembleDebug --no-daemon -PignoreFailures=true -x test -x lint

      - name: 6. 提取 APK 成品
        if: always()
        run: |
          mkdir -p final_apk
          find . -name "*.apk" -ls -exec cp {} ./final_apk/ \;

      - name: 7. 交付 (在此下载)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: TGX_FINAL_APK
          path: final_apk/
