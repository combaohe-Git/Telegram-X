name: TGX_ULTIMATE_FIX
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 清理环境 (核心第一步)
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android/sdk/platforms/android-28 /usr/local/lib/android/sdk/platforms/android-29
          sudo docker image prune -a -f
          df -h

      - name: 2. 克隆源码
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: 3. 精准安装 NDK 23.2
        run: |
          # 必须先清理旧 NDK 才能保证路径唯一性
          sudo rm -rf /usr/local/lib/android/sdk/ndk/*
          yes | sudo /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager --install "ndk;23.2.8568313"

      - name: 4. 环境配置 (Java 21)
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'

      - name: 5. 修复 API 配置与 NDK 关联
        run: |
          # 修复 local.properties，直接指向刚才安装的 NDK
          echo "ndk.dir=/usr/local/lib/android/sdk/ndk/23.2.8568313" > local.properties
          echo "telegram.api_id=39843586" >> local.properties
          echo "telegram.api_hash=6566d860f3317765664161c9e88b901a" >> local.properties

      - name: 6. 暴力编译 (强制通过模式)
        run: |
          chmod +x gradlew
          # 使用 --no-daemon 减少内存占用，设置堆内存限制
          export GRADLE_OPTS="-Xmx4g -XX:MaxMetaspaceSize=1g"
          ./gradlew :app:assembleDebug \
            --no-daemon \
            -Dorg.gradle.workers.max=1 \
            -PignoreFailures=true \
            -x test -x lint

      - name: 7. 搜寻并导出 APK
        if: always()
        run: |
          mkdir -p final_apk
          find . -name "*.apk" -ls -exec cp {} ./final_apk/ \;

      - name: 8. 交付成果物
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: TGX_PRODUCTION_APK
          path: final_apk/
