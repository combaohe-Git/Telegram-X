name: Expert Final Success
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 拉取代码
        uses: actions/checkout@v4

      - name: 2. 深度环境重置
        run: |
          # 强制删除所有干扰文件，防止 48 秒闪退
          rm -f local.properties gradle.properties
          # 强制还原 Java 源码，清除之前手动修改的所有错误
          git checkout HEAD -- *.java || true

      - name: 3. 安装 Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: 4. 工业级环境注入
        run: |
          # 1. 安装 NDK
          SDK_MANAGER=$(find ${ANDROID_SDK_ROOT} -name sdkmanager | head -n 1)
          echo "y" | $SDK_MANAGER --install "ndk;25.2.9519653"
          
          # 2. 精准写入配置，不留任何空格或特殊字符
          printf "api_id=39843586\napi_hash=6566d860f3317765664161c9e88b901a\nndk.dir=${ANDROID_SDK_ROOT}/ndk/25.2.9519653" > local.properties
          
          # 3. 内存与兼容性硬化
          printf "org.gradle.jvmargs=-Xmx4096m\nandroid.useAndroidX=true\nandroid.enableJetifier=true" > gradle.properties

      - name: 5. 最终编译交付
        run: |
          chmod +x gradlew
          # 使用 --stacktrace 捕捉底层错误，--no-daemon 确保不产生日志中提到的 Daemon 冲突
          ./gradlew clean assembleDebug --no-daemon --stacktrace

      - name: 6. 提取成品
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: PG助手-正式版
          path: "**/build/outputs/apk/debug/*.apk"
