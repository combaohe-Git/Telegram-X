name: Force_Wipe_Hardcoded_Path
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'

      - name: 物理擦除硬编码 NDK 设置
        run: |
          # 1. 注入 API 凭证
          echo "telegram.api_id=39843586" > local.properties
          echo "telegram.api_hash=6566d860f3317765664161c9e88b901a" >> local.properties
          
          # 2. 探测服务器真实的 NDK 路径
          REAL_NDK=$(ls -d /usr/local/lib/android/sdk/ndk/2* | head -n 1)
          echo "ndk.dir=$REAL_NDK" >> local.properties
          
          # 3. 终极一击：在所有 build.gradle 文件中，强行删掉包含 ndkPath 的那一行代码
          # 这样 Gradle 就会放弃去找 23.2.8568313，转而使用我们在 local.properties 提供的路径
          find . -name "build.gradle*" -exec sed -i '/ndkPath/d' {} +
          find . -name "build.gradle*" -exec sed -i '/ndkVersion/d' {} +
          
          echo "已物理删除所有硬编码 NDK 路径设置"

      - name: 锁定 Gradle 8.13
        run: |
          mkdir -p gradle/wrapper
          echo "distributionUrl=https\://services.gradle.org/distributions/gradle-8.13-bin.zip" > gradle/wrapper/gradle-wrapper.properties

      - name: 执行单线程编译 (防内存崩溃)
        run: |
          chmod +x gradlew
          ./gradlew :app:assembleDebug --no-daemon -Dorg.gradle.workers.max=1 -Dorg.gradle.jvmargs="-Xmx6g" -x test -x lint

      - name: 强制提取 APK
        if: always()
        run: |
          mkdir -p output
          find . -name "*.apk" -exec cp {} ./output/ \;

      - name: 交付
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: TGX_FIXED_APK
          path: output/
