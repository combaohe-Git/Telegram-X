name: TGX_Auto_Factory
on: 
  push:
    branches: [ main ]
  workflow_dispatch: # 支持手动点击运行

jobs:
  build_apk:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 准备底座环境 (官方仓库)
        run: |
          git clone --depth 1 --recursive https://github.com/TGX-Android/Telegram-X.git base_repo

      - name: 2. 准备你的修改代码
        uses: actions/checkout@v4
        with:
          path: my_changes

      - name: 3. 核心代码自动化合并
        run: |
          # 自动注入 API 参数
          echo "telegram.api_id=39843586" > base_repo/local.properties
          echo "telegram.api_hash=6566d860f3317765664161c9e88b901a" >> base_repo/local.properties
          
          # 自动将你的注册修改逻辑“覆盖”到底座
          # 只复制 src 下的文件，保护底座的 Gradle 配置不被破坏
          if [ -d "my_changes/app/src" ]; then
            cp -rv my_changes/app/src/* base_repo/app/src/
          fi

      - name: 4. 启动自动化生产线 (Java 21)
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'
          cache: 'gradle'

      - name: 5. 强制执行编译
        run: |
          cd base_repo
          chmod +x gradlew
          # 使用 --no-daemon 模式最稳定，跳过测试提高速度
          ./gradlew :app:assembleDebug --no-daemon -x test -x lint

      - name: 6. 自动打包产出物
        if: success()
        run: |
          mkdir -p final_apk
          find base_repo/app/build/outputs/apk/debug/ -name "*.apk" -exec cp {} ./final_apk/ \;

      - name: 7. 推送到你的手机下载端
        uses: actions/upload-artifact@v4
        with:
          name: TGX_Ready_To_Install
          path: final_apk/
